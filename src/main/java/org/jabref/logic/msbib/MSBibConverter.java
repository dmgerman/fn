begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
DECL|package|org.jabref.logic.msbib
package|package
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|msbib
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|Author
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|AuthorList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|BibEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|Month
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|StandardEntryType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|field
operator|.
name|Field
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|field
operator|.
name|StandardField
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|field
operator|.
name|UnknownField
import|;
end_import

begin_class
DECL|class|MSBibConverter
specifier|public
class|class
name|MSBibConverter
block|{
DECL|field|MSBIB_PREFIX
specifier|private
specifier|static
specifier|final
name|String
name|MSBIB_PREFIX
init|=
literal|"msbib-"
decl_stmt|;
DECL|field|BIBTEX_PREFIX
specifier|private
specifier|static
specifier|final
name|String
name|BIBTEX_PREFIX
init|=
literal|"BIBTEX_"
decl_stmt|;
DECL|method|MSBibConverter ()
specifier|private
name|MSBibConverter
parameter_list|()
block|{     }
DECL|method|convert (BibEntry entry)
specifier|public
specifier|static
name|MSBibEntry
name|convert
parameter_list|(
name|BibEntry
name|entry
parameter_list|)
block|{
name|MSBibEntry
name|result
init|=
operator|new
name|MSBibEntry
argument_list|()
decl_stmt|;
comment|// memorize original type
name|result
operator|.
name|fields
operator|.
name|put
argument_list|(
name|BIBTEX_PREFIX
operator|+
literal|"Entry"
argument_list|,
name|entry
operator|.
name|getType
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
comment|// define new type
name|String
name|msBibType
init|=
name|MSBibMapping
operator|.
name|getMSBibEntryType
argument_list|(
name|entry
operator|.
name|getType
argument_list|()
argument_list|)
operator|.
name|name
argument_list|()
decl_stmt|;
name|result
operator|.
name|fields
operator|.
name|put
argument_list|(
literal|"SourceType"
argument_list|,
name|msBibType
argument_list|)
expr_stmt|;
for|for
control|(
name|Field
name|field
range|:
name|entry
operator|.
name|getFields
argument_list|()
control|)
block|{
name|String
name|msBibField
init|=
name|MSBibMapping
operator|.
name|getMSBibField
argument_list|(
name|field
argument_list|)
decl_stmt|;
if|if
condition|(
name|msBibField
operator|!=
literal|null
condition|)
block|{
name|String
name|value
init|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|field
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|result
operator|.
name|fields
operator|.
name|put
argument_list|(
name|msBibField
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Duplicate: also added as BookTitle
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|BOOKTITLE
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|booktitle
lambda|->
name|result
operator|.
name|conferenceName
operator|=
name|booktitle
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|PAGES
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|pages
lambda|->
name|result
operator|.
name|pages
operator|=
operator|new
name|PageNumbers
argument_list|(
name|pages
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getLatexFreeField
argument_list|(
operator|new
name|UnknownField
argument_list|(
name|MSBIB_PREFIX
operator|+
literal|"accessed"
argument_list|)
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|accesed
lambda|->
name|result
operator|.
name|dateAccessed
operator|=
name|accesed
argument_list|)
expr_stmt|;
comment|// TODO: currently this can never happen
if|if
condition|(
literal|"SoundRecording"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
condition|)
block|{
name|result
operator|.
name|albumTitle
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|TITLE
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
comment|// TODO: currently this can never happen
if|if
condition|(
literal|"Interview"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
condition|)
block|{
name|result
operator|.
name|broadcastTitle
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|TITLE
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|result
operator|.
name|number
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|NUMBER
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
name|StandardEntryType
operator|.
name|Patent
argument_list|)
condition|)
block|{
name|result
operator|.
name|patentNumber
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|NUMBER
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|result
operator|.
name|number
operator|=
literal|null
expr_stmt|;
block|}
name|result
operator|.
name|day
operator|=
name|entry
operator|.
name|getFieldOrAliasLatexFree
argument_list|(
name|StandardField
operator|.
name|DAY
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|result
operator|.
name|month
operator|=
name|entry
operator|.
name|getMonth
argument_list|()
operator|.
name|map
argument_list|(
name|Month
operator|::
name|getNumber
argument_list|)
operator|.
name|map
argument_list|(
name|Object
operator|::
name|toString
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|YEAR
argument_list|)
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|result
operator|.
name|year
operator|=
name|entry
operator|.
name|getFieldOrAliasLatexFree
argument_list|(
name|StandardField
operator|.
name|YEAR
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|result
operator|.
name|journalName
operator|=
name|entry
operator|.
name|getFieldOrAliasLatexFree
argument_list|(
name|StandardField
operator|.
name|JOURNAL
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
comment|// Value must be converted
comment|//Currently only english is supported
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|LANGUAGE
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|lang
lambda|->
name|result
operator|.
name|fields
operator|.
name|put
argument_list|(
literal|"LCID"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|MSBibMapping
operator|.
name|getLCID
argument_list|(
name|lang
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|StringBuilder
name|sbNumber
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|ISBN
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|isbn
lambda|->
name|sbNumber
operator|.
name|append
argument_list|(
literal|" ISBN: "
operator|+
name|isbn
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|ISSN
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|issn
lambda|->
name|sbNumber
operator|.
name|append
argument_list|(
literal|" ISSN: "
operator|+
name|issn
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getLatexFreeField
argument_list|(
operator|new
name|UnknownField
argument_list|(
literal|"lccn"
argument_list|)
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|lccn
lambda|->
name|sbNumber
operator|.
name|append
argument_list|(
literal|"LCCN: "
operator|+
name|lccn
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|MR_NUMBER
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|mrnumber
lambda|->
name|sbNumber
operator|.
name|append
argument_list|(
literal|" MRN: "
operator|+
name|mrnumber
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|.
name|standardNumber
operator|=
name|sbNumber
operator|.
name|toString
argument_list|()
expr_stmt|;
if|if
condition|(
name|result
operator|.
name|standardNumber
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|result
operator|.
name|standardNumber
operator|=
literal|null
expr_stmt|;
block|}
name|result
operator|.
name|address
operator|=
name|entry
operator|.
name|getFieldOrAliasLatexFree
argument_list|(
name|StandardField
operator|.
name|ADDRESS
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|TYPE
argument_list|)
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|result
operator|.
name|thesisType
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|TYPE
argument_list|)
operator|.
name|get
argument_list|()
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|entry
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
name|StandardEntryType
operator|.
name|TechReport
argument_list|)
condition|)
block|{
name|result
operator|.
name|thesisType
operator|=
literal|"Tech. rep."
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
name|StandardEntryType
operator|.
name|MastersThesis
argument_list|)
condition|)
block|{
name|result
operator|.
name|thesisType
operator|=
literal|"Master's thesis"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
name|StandardEntryType
operator|.
name|PhdThesis
argument_list|)
condition|)
block|{
name|result
operator|.
name|thesisType
operator|=
literal|"Ph.D. dissertation"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
name|StandardEntryType
operator|.
name|Unpublished
argument_list|)
condition|)
block|{
name|result
operator|.
name|thesisType
operator|=
literal|"unpublished"
expr_stmt|;
block|}
block|}
comment|// TODO: currently this can never happen
if|if
condition|(
operator|(
literal|"InternetSite"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
operator|||
literal|"DocumentFromInternetSite"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
operator|)
condition|)
block|{
name|result
operator|.
name|internetSiteTitle
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|TITLE
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
comment|// TODO: currently only Misc can happen
if|if
condition|(
literal|"ElectronicSource"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
operator|||
literal|"Art"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
operator|||
literal|"Misc"
operator|.
name|equals
argument_list|(
name|msBibType
argument_list|)
condition|)
block|{
name|result
operator|.
name|publicationTitle
operator|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|StandardField
operator|.
name|TITLE
argument_list|)
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|entry
operator|.
name|getField
argument_list|(
name|StandardField
operator|.
name|AUTHOR
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|authors
lambda|->
name|result
operator|.
name|authors
operator|=
name|getAuthors
argument_list|(
name|entry
argument_list|,
name|authors
argument_list|,
name|StandardField
operator|.
name|AUTHOR
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getField
argument_list|(
name|StandardField
operator|.
name|EDITOR
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|editors
lambda|->
name|result
operator|.
name|editors
operator|=
name|getAuthors
argument_list|(
name|entry
argument_list|,
name|editors
argument_list|,
name|StandardField
operator|.
name|EDITOR
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|getField
argument_list|(
name|StandardField
operator|.
name|TRANSLATOR
argument_list|)
operator|.
name|ifPresent
argument_list|(
name|translator
lambda|->
name|result
operator|.
name|translators
operator|=
name|getAuthors
argument_list|(
name|entry
argument_list|,
name|translator
argument_list|,
name|StandardField
operator|.
name|EDITOR
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
DECL|method|getAuthors (BibEntry entry, String authors, Field field)
specifier|private
specifier|static
name|List
argument_list|<
name|MsBibAuthor
argument_list|>
name|getAuthors
parameter_list|(
name|BibEntry
name|entry
parameter_list|,
name|String
name|authors
parameter_list|,
name|Field
name|field
parameter_list|)
block|{
name|List
argument_list|<
name|MsBibAuthor
argument_list|>
name|result
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|boolean
name|corporate
init|=
literal|false
decl_stmt|;
comment|//Only one corporate author is supported
comment|//We have the possible rare case that are multiple authors which start and end with latex , this is currently not considered
if|if
condition|(
name|authors
operator|.
name|startsWith
argument_list|(
literal|"{"
argument_list|)
operator|&&
name|authors
operator|.
name|endsWith
argument_list|(
literal|"}"
argument_list|)
condition|)
block|{
name|corporate
operator|=
literal|true
expr_stmt|;
block|}
comment|//FIXME: #4152 This is an ugly hack because the latex2unicode formatter kills of all curly braces, so no more corporate author parsing possible
name|String
name|authorLatexFree
init|=
name|entry
operator|.
name|getLatexFreeField
argument_list|(
name|field
argument_list|)
operator|.
name|orElse
argument_list|(
literal|""
argument_list|)
decl_stmt|;
if|if
condition|(
name|corporate
condition|)
block|{
name|authorLatexFree
operator|=
literal|"{"
operator|+
name|authorLatexFree
operator|+
literal|"}"
expr_stmt|;
block|}
name|AuthorList
name|authorList
init|=
name|AuthorList
operator|.
name|parse
argument_list|(
name|authorLatexFree
argument_list|)
decl_stmt|;
for|for
control|(
name|Author
name|author
range|:
name|authorList
operator|.
name|getAuthors
argument_list|()
control|)
block|{
name|result
operator|.
name|add
argument_list|(
operator|new
name|MsBibAuthor
argument_list|(
name|author
argument_list|,
name|corporate
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
block|}
end_class

end_unit

