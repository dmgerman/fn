begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
DECL|package|org.jabref.gui.search.rules.describer
package|package
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|search
operator|.
name|rules
operator|.
name|describer
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Objects
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|text
operator|.
name|Text
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|text
operator|.
name|TextFlow
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|util
operator|.
name|TooltipTextUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|l10n
operator|.
name|Localization
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|search
operator|.
name|rules
operator|.
name|GrammarBasedSearchRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|strings
operator|.
name|StringUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|search
operator|.
name|SearchBaseVisitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|search
operator|.
name|SearchParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|antlr
operator|.
name|v4
operator|.
name|runtime
operator|.
name|tree
operator|.
name|ParseTree
import|;
end_import

begin_class
DECL|class|GrammarBasedSearchRuleDescriber
specifier|public
class|class
name|GrammarBasedSearchRuleDescriber
implements|implements
name|SearchDescriber
block|{
DECL|field|caseSensitive
specifier|private
specifier|final
name|boolean
name|caseSensitive
decl_stmt|;
DECL|field|regExp
specifier|private
specifier|final
name|boolean
name|regExp
decl_stmt|;
DECL|field|parseTree
specifier|private
specifier|final
name|ParseTree
name|parseTree
decl_stmt|;
DECL|method|GrammarBasedSearchRuleDescriber (boolean caseSensitive, boolean regExp, ParseTree parseTree)
specifier|public
name|GrammarBasedSearchRuleDescriber
parameter_list|(
name|boolean
name|caseSensitive
parameter_list|,
name|boolean
name|regExp
parameter_list|,
name|ParseTree
name|parseTree
parameter_list|)
block|{
name|this
operator|.
name|caseSensitive
operator|=
name|caseSensitive
expr_stmt|;
name|this
operator|.
name|regExp
operator|=
name|regExp
expr_stmt|;
name|this
operator|.
name|parseTree
operator|=
name|Objects
operator|.
name|requireNonNull
argument_list|(
name|parseTree
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|getDescription ()
specifier|public
name|TextFlow
name|getDescription
parameter_list|()
block|{
name|TextFlow
name|textFlow
init|=
operator|new
name|TextFlow
argument_list|()
decl_stmt|;
name|DescriptionSearchBaseVisitor
name|descriptionSearchBaseVisitor
init|=
operator|new
name|DescriptionSearchBaseVisitor
argument_list|()
decl_stmt|;
comment|// describe advanced search expression
name|textFlow
operator|.
name|getChildren
argument_list|()
operator|.
name|add
argument_list|(
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"%s "
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"This search contains entries in which"
argument_list|)
argument_list|)
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
name|textFlow
operator|.
name|getChildren
argument_list|()
operator|.
name|addAll
argument_list|(
name|descriptionSearchBaseVisitor
operator|.
name|visit
argument_list|(
name|parseTree
argument_list|)
argument_list|)
expr_stmt|;
name|textFlow
operator|.
name|getChildren
argument_list|()
operator|.
name|add
argument_list|(
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
literal|". "
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
name|textFlow
operator|.
name|getChildren
argument_list|()
operator|.
name|add
argument_list|(
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
name|caseSensitive
condition|?
name|Localization
operator|.
name|lang
argument_list|(
literal|"The search is case sensitive."
argument_list|)
else|:
name|Localization
operator|.
name|lang
argument_list|(
literal|"The search is case insensitive."
argument_list|)
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|textFlow
return|;
block|}
DECL|class|DescriptionSearchBaseVisitor
specifier|private
class|class
name|DescriptionSearchBaseVisitor
extends|extends
name|SearchBaseVisitor
argument_list|<
name|List
argument_list|<
name|Text
argument_list|>
argument_list|>
block|{
annotation|@
name|Override
DECL|method|visitStart (SearchParser.StartContext context)
specifier|public
name|List
argument_list|<
name|Text
argument_list|>
name|visitStart
parameter_list|(
name|SearchParser
operator|.
name|StartContext
name|context
parameter_list|)
block|{
return|return
name|visit
argument_list|(
name|context
operator|.
name|expression
argument_list|()
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|visitUnaryExpression (SearchParser.UnaryExpressionContext context)
specifier|public
name|List
argument_list|<
name|Text
argument_list|>
name|visitUnaryExpression
parameter_list|(
name|SearchParser
operator|.
name|UnaryExpressionContext
name|context
parameter_list|)
block|{
name|List
argument_list|<
name|Text
argument_list|>
name|textList
init|=
name|visit
argument_list|(
name|context
operator|.
name|expression
argument_list|()
argument_list|)
decl_stmt|;
name|textList
operator|.
name|add
argument_list|(
literal|0
argument_list|,
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"not"
argument_list|)
operator|.
name|concat
argument_list|(
literal|" "
argument_list|)
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|textList
return|;
block|}
annotation|@
name|Override
DECL|method|visitParenExpression (SearchParser.ParenExpressionContext context)
specifier|public
name|List
argument_list|<
name|Text
argument_list|>
name|visitParenExpression
parameter_list|(
name|SearchParser
operator|.
name|ParenExpressionContext
name|context
parameter_list|)
block|{
name|ArrayList
argument_list|<
name|Text
argument_list|>
name|textList
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|textList
operator|.
name|add
argument_list|(
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"%s"
argument_list|,
name|context
operator|.
name|expression
argument_list|()
argument_list|)
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|textList
return|;
block|}
annotation|@
name|Override
DECL|method|visitBinaryExpression (SearchParser.BinaryExpressionContext context)
specifier|public
name|List
argument_list|<
name|Text
argument_list|>
name|visitBinaryExpression
parameter_list|(
name|SearchParser
operator|.
name|BinaryExpressionContext
name|context
parameter_list|)
block|{
name|List
argument_list|<
name|Text
argument_list|>
name|textList
init|=
name|visit
argument_list|(
name|context
operator|.
name|left
argument_list|)
decl_stmt|;
if|if
condition|(
literal|"AND"
operator|.
name|equalsIgnoreCase
argument_list|(
name|context
operator|.
name|operator
operator|.
name|getText
argument_list|()
argument_list|)
condition|)
block|{
name|textList
operator|.
name|add
argument_list|(
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|" %s "
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"and"
argument_list|)
argument_list|)
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|textList
operator|.
name|add
argument_list|(
name|TooltipTextUtil
operator|.
name|createText
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|" %s "
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"or"
argument_list|)
argument_list|)
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|NORMAL
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|textList
operator|.
name|addAll
argument_list|(
name|visit
argument_list|(
name|context
operator|.
name|right
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|textList
return|;
block|}
annotation|@
name|Override
DECL|method|visitComparison (SearchParser.ComparisonContext context)
specifier|public
name|List
argument_list|<
name|Text
argument_list|>
name|visitComparison
parameter_list|(
name|SearchParser
operator|.
name|ComparisonContext
name|context
parameter_list|)
block|{
specifier|final
name|List
argument_list|<
name|Text
argument_list|>
name|textList
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|final
name|Optional
argument_list|<
name|SearchParser
operator|.
name|NameContext
argument_list|>
name|fieldDescriptor
init|=
name|Optional
operator|.
name|ofNullable
argument_list|(
name|context
operator|.
name|left
argument_list|)
decl_stmt|;
specifier|final
name|String
name|value
init|=
name|StringUtil
operator|.
name|unquote
argument_list|(
name|context
operator|.
name|right
operator|.
name|getText
argument_list|()
argument_list|,
literal|'"'
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|fieldDescriptor
operator|.
name|isPresent
argument_list|()
condition|)
block|{
name|TextFlow
name|description
init|=
operator|new
name|ContainsAndRegexBasedSearchRuleDescriber
argument_list|(
name|caseSensitive
argument_list|,
name|regExp
argument_list|,
name|value
argument_list|)
operator|.
name|getDescription
argument_list|()
decl_stmt|;
name|description
operator|.
name|getChildren
argument_list|()
operator|.
name|forEach
argument_list|(
name|it
lambda|->
name|textList
operator|.
name|add
argument_list|(
operator|(
name|Text
operator|)
name|it
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|textList
return|;
block|}
specifier|final
name|String
name|field
init|=
name|StringUtil
operator|.
name|unquote
argument_list|(
name|fieldDescriptor
operator|.
name|get
argument_list|()
operator|.
name|getText
argument_list|()
argument_list|,
literal|'"'
argument_list|)
decl_stmt|;
specifier|final
name|GrammarBasedSearchRule
operator|.
name|ComparisonOperator
name|operator
init|=
name|GrammarBasedSearchRule
operator|.
name|ComparisonOperator
operator|.
name|build
argument_list|(
name|context
operator|.
name|operator
operator|.
name|getText
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|boolean
name|regExpFieldSpec
init|=
operator|!
name|Pattern
operator|.
name|matches
argument_list|(
literal|"\\w+"
argument_list|,
name|field
argument_list|)
decl_stmt|;
name|String
name|temp
init|=
name|regExpFieldSpec
condition|?
name|Localization
operator|.
name|lang
argument_list|(
literal|"any field that matches the regular expression<b>%0</b>"
argument_list|)
else|:
name|Localization
operator|.
name|lang
argument_list|(
literal|"the field<b>%0</b>"
argument_list|)
decl_stmt|;
if|if
condition|(
name|operator
operator|==
name|GrammarBasedSearchRule
operator|.
name|ComparisonOperator
operator|.
name|CONTAINS
condition|)
block|{
if|if
condition|(
name|regExp
condition|)
block|{
name|temp
operator|=
name|Localization
operator|.
name|lang
argument_list|(
literal|"%0 contains the regular expression<b>%1</b>"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|Localization
operator|.
name|lang
argument_list|(
literal|"%0 contains the term<b>%1</b>"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|operator
operator|==
name|GrammarBasedSearchRule
operator|.
name|ComparisonOperator
operator|.
name|EXACT
condition|)
block|{
if|if
condition|(
name|regExp
condition|)
block|{
name|temp
operator|=
name|Localization
operator|.
name|lang
argument_list|(
literal|"%0 matches the regular expression<b>%1</b>"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|Localization
operator|.
name|lang
argument_list|(
literal|"%0 matches the term<b>%1</b>"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|operator
operator|==
name|GrammarBasedSearchRule
operator|.
name|ComparisonOperator
operator|.
name|DOES_NOT_CONTAIN
condition|)
block|{
if|if
condition|(
name|regExp
condition|)
block|{
name|temp
operator|=
name|Localization
operator|.
name|lang
argument_list|(
literal|"%0 doesn't contain the regular expression<b>%1</b>"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|Localization
operator|.
name|lang
argument_list|(
literal|"%0 doesn't contain the term<b>%1</b>"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"CANNOT HAPPEN!"
argument_list|)
throw|;
block|}
name|List
argument_list|<
name|Text
argument_list|>
name|formattedTexts
init|=
name|TooltipTextUtil
operator|.
name|formatToTexts
argument_list|(
name|temp
argument_list|,
operator|new
name|TooltipTextUtil
operator|.
name|TextReplacement
argument_list|(
literal|"<b>%0</b>"
argument_list|,
name|field
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|BOLD
argument_list|)
argument_list|,
operator|new
name|TooltipTextUtil
operator|.
name|TextReplacement
argument_list|(
literal|"<b>%1</b>"
argument_list|,
name|value
argument_list|,
name|TooltipTextUtil
operator|.
name|TextType
operator|.
name|BOLD
argument_list|)
argument_list|)
decl_stmt|;
name|textList
operator|.
name|addAll
argument_list|(
name|formattedTexts
argument_list|)
expr_stmt|;
return|return
name|textList
return|;
block|}
block|}
block|}
end_class

end_unit

