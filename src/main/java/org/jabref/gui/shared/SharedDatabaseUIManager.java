begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
DECL|package|org.jabref.gui.shared
package|package
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|shared
package|;
end_package

begin_import
import|import
name|java
operator|.
name|sql
operator|.
name|SQLException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Objects
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|control
operator|.
name|Alert
operator|.
name|AlertType
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|control
operator|.
name|ButtonBar
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|control
operator|.
name|ButtonBar
operator|.
name|ButtonData
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|control
operator|.
name|ButtonType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|Globals
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|BasePanel
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|DialogService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|JabRefFrame
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|entryeditor
operator|.
name|EntryEditor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|exporter
operator|.
name|SaveDatabaseAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|mergeentries
operator|.
name|MergeEntriesDialog
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|undo
operator|.
name|UndoableRemoveEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|importer
operator|.
name|ParserResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|l10n
operator|.
name|Localization
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|DBMSConnection
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|DBMSConnectionProperties
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|DBMSSynchronizer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|event
operator|.
name|ConnectionLostEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|event
operator|.
name|SharedEntryNotPresentEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|event
operator|.
name|UpdateRefusedEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|exception
operator|.
name|InvalidDBMSConnectionPropertiesException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|exception
operator|.
name|NotASharedDatabaseException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|logic
operator|.
name|shared
operator|.
name|prefs
operator|.
name|SharedDatabasePreferences
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|Defaults
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|database
operator|.
name|BibDatabaseContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|database
operator|.
name|BibDatabaseMode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|database
operator|.
name|shared
operator|.
name|DatabaseNotSupportedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|database
operator|.
name|shared
operator|.
name|DatabaseSynchronizer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|entry
operator|.
name|BibEntry
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|eventbus
operator|.
name|Subscribe
import|;
end_import

begin_class
DECL|class|SharedDatabaseUIManager
specifier|public
class|class
name|SharedDatabaseUIManager
block|{
DECL|field|jabRefFrame
specifier|private
specifier|final
name|JabRefFrame
name|jabRefFrame
decl_stmt|;
DECL|field|dbmsSynchronizer
specifier|private
name|DatabaseSynchronizer
name|dbmsSynchronizer
decl_stmt|;
DECL|field|dialogService
specifier|private
specifier|final
name|DialogService
name|dialogService
decl_stmt|;
DECL|method|SharedDatabaseUIManager (JabRefFrame jabRefFrame)
specifier|public
name|SharedDatabaseUIManager
parameter_list|(
name|JabRefFrame
name|jabRefFrame
parameter_list|)
block|{
name|this
operator|.
name|jabRefFrame
operator|=
name|jabRefFrame
expr_stmt|;
name|this
operator|.
name|dialogService
operator|=
name|jabRefFrame
operator|.
name|getDialogService
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Subscribe
DECL|method|listen (ConnectionLostEvent connectionLostEvent)
specifier|public
name|void
name|listen
parameter_list|(
name|ConnectionLostEvent
name|connectionLostEvent
parameter_list|)
block|{
name|jabRefFrame
operator|.
name|getDialogService
argument_list|()
operator|.
name|notify
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Connection lost."
argument_list|)
argument_list|)
expr_stmt|;
name|ButtonType
name|reconnect
init|=
operator|new
name|ButtonType
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Reconnect"
argument_list|)
argument_list|,
name|ButtonData
operator|.
name|YES
argument_list|)
decl_stmt|;
name|ButtonType
name|workOffline
init|=
operator|new
name|ButtonType
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Work offline"
argument_list|)
argument_list|,
name|ButtonData
operator|.
name|NO
argument_list|)
decl_stmt|;
name|ButtonType
name|closeLibrary
init|=
operator|new
name|ButtonType
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Close library"
argument_list|)
argument_list|,
name|ButtonData
operator|.
name|CANCEL_CLOSE
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|ButtonType
argument_list|>
name|answer
init|=
name|dialogService
operator|.
name|showCustomButtonDialogAndWait
argument_list|(
name|AlertType
operator|.
name|WARNING
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"Connection lost"
argument_list|)
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"The connection to the server has been terminated."
argument_list|)
argument_list|,
name|reconnect
argument_list|,
name|workOffline
argument_list|,
name|closeLibrary
argument_list|)
decl_stmt|;
if|if
condition|(
name|answer
operator|.
name|isPresent
argument_list|()
condition|)
block|{
if|if
condition|(
name|answer
operator|.
name|get
argument_list|()
operator|.
name|equals
argument_list|(
name|reconnect
argument_list|)
condition|)
block|{
name|jabRefFrame
operator|.
name|closeCurrentTab
argument_list|()
expr_stmt|;
operator|new
name|SharedDatabaseLoginDialogView
argument_list|(
name|jabRefFrame
argument_list|)
operator|.
name|showAndWait
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|answer
operator|.
name|get
argument_list|()
operator|.
name|equals
argument_list|(
name|workOffline
argument_list|)
condition|)
block|{
name|connectionLostEvent
operator|.
name|getBibDatabaseContext
argument_list|()
operator|.
name|convertToLocalDatabase
argument_list|()
expr_stmt|;
name|jabRefFrame
operator|.
name|refreshTitleAndTabs
argument_list|()
expr_stmt|;
name|jabRefFrame
operator|.
name|getDialogService
argument_list|()
operator|.
name|notify
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Working offline."
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|jabRefFrame
operator|.
name|closeCurrentTab
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Subscribe
DECL|method|listen (UpdateRefusedEvent updateRefusedEvent)
specifier|public
name|void
name|listen
parameter_list|(
name|UpdateRefusedEvent
name|updateRefusedEvent
parameter_list|)
block|{
name|jabRefFrame
operator|.
name|getDialogService
argument_list|()
operator|.
name|notify
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Update refused."
argument_list|)
argument_list|)
expr_stmt|;
name|BibEntry
name|localBibEntry
init|=
name|updateRefusedEvent
operator|.
name|getLocalBibEntry
argument_list|()
decl_stmt|;
name|BibEntry
name|sharedBibEntry
init|=
name|updateRefusedEvent
operator|.
name|getSharedBibEntry
argument_list|()
decl_stmt|;
name|StringBuilder
name|message
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|message
operator|.
name|append
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Update could not be performed due to existing change conflicts."
argument_list|)
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"You are not working on the newest version of BibEntry."
argument_list|)
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Shared version: %0"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|sharedBibEntry
operator|.
name|getSharedBibEntryData
argument_list|()
operator|.
name|getVersion
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Local version: %0"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|localBibEntry
operator|.
name|getSharedBibEntryData
argument_list|()
operator|.
name|getVersion
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Press \"Merge entries\" to merge the changes and resolve this problem."
argument_list|)
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|message
operator|.
name|append
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Canceling this operation will leave your changes unsynchronized."
argument_list|)
argument_list|)
expr_stmt|;
name|ButtonType
name|merge
init|=
operator|new
name|ButtonType
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Merge entries"
argument_list|)
argument_list|,
name|ButtonBar
operator|.
name|ButtonData
operator|.
name|YES
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|ButtonType
argument_list|>
name|response
init|=
name|dialogService
operator|.
name|showCustomButtonDialogAndWait
argument_list|(
name|AlertType
operator|.
name|CONFIRMATION
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"Update refused"
argument_list|)
argument_list|,
name|message
operator|.
name|toString
argument_list|()
argument_list|,
name|ButtonType
operator|.
name|CANCEL
argument_list|,
name|merge
argument_list|)
decl_stmt|;
if|if
condition|(
name|response
operator|.
name|isPresent
argument_list|()
operator|&&
name|response
operator|.
name|get
argument_list|()
operator|.
name|equals
argument_list|(
name|merge
argument_list|)
condition|)
block|{
name|MergeEntriesDialog
name|dialog
init|=
operator|new
name|MergeEntriesDialog
argument_list|(
name|localBibEntry
argument_list|,
name|sharedBibEntry
argument_list|,
name|updateRefusedEvent
operator|.
name|getBibDatabaseContext
argument_list|()
operator|.
name|getMode
argument_list|()
argument_list|)
decl_stmt|;
name|Optional
argument_list|<
name|BibEntry
argument_list|>
name|mergedEntry
init|=
name|dialog
operator|.
name|showAndWait
argument_list|()
decl_stmt|;
name|mergedEntry
operator|.
name|ifPresent
argument_list|(
name|mergedBibEntry
lambda|->
block|{
name|mergedBibEntry
operator|.
name|getSharedBibEntryData
argument_list|()
operator|.
name|setSharedID
argument_list|(
name|sharedBibEntry
operator|.
name|getSharedBibEntryData
argument_list|()
operator|.
name|getSharedID
argument_list|()
argument_list|)
expr_stmt|;
name|mergedBibEntry
operator|.
name|getSharedBibEntryData
argument_list|()
operator|.
name|setVersion
argument_list|(
name|sharedBibEntry
operator|.
name|getSharedBibEntryData
argument_list|()
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
name|dbmsSynchronizer
operator|.
name|synchronizeSharedEntry
argument_list|(
name|mergedBibEntry
argument_list|)
expr_stmt|;
name|dbmsSynchronizer
operator|.
name|synchronizeLocalDatabase
argument_list|()
expr_stmt|;
block|}
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Subscribe
DECL|method|listen (SharedEntryNotPresentEvent event)
specifier|public
name|void
name|listen
parameter_list|(
name|SharedEntryNotPresentEvent
name|event
parameter_list|)
block|{
name|BasePanel
name|panel
init|=
name|jabRefFrame
operator|.
name|getCurrentBasePanel
argument_list|()
decl_stmt|;
name|EntryEditor
name|entryEditor
init|=
name|panel
operator|.
name|getEntryEditor
argument_list|()
decl_stmt|;
name|panel
operator|.
name|getUndoManager
argument_list|()
operator|.
name|addEdit
argument_list|(
operator|new
name|UndoableRemoveEntry
argument_list|(
name|panel
operator|.
name|getDatabase
argument_list|()
argument_list|,
name|event
operator|.
name|getBibEntry
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Objects
operator|.
name|nonNull
argument_list|(
name|entryEditor
argument_list|)
operator|&&
operator|(
name|entryEditor
operator|.
name|getEntry
argument_list|()
operator|==
name|event
operator|.
name|getBibEntry
argument_list|()
operator|)
condition|)
block|{
name|dialogService
operator|.
name|showInformationDialogAndWait
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Shared entry is no longer present"
argument_list|)
argument_list|,
name|Localization
operator|.
name|lang
argument_list|(
literal|"The entry you currently work on has been deleted on the shared side."
argument_list|)
operator|+
literal|"\n"
operator|+
name|Localization
operator|.
name|lang
argument_list|(
literal|"You can restore the entry using the \"Undo\" operation."
argument_list|)
argument_list|)
expr_stmt|;
name|panel
operator|.
name|closeBottomPane
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Opens a new shared database tab with the given {@link DBMSConnectionProperties}.      *      * @param dbmsConnectionProperties Connection data      * @return BasePanel which also used by {@link SaveDatabaseAction}      */
DECL|method|openNewSharedDatabaseTab (DBMSConnectionProperties dbmsConnectionProperties)
specifier|public
name|BasePanel
name|openNewSharedDatabaseTab
parameter_list|(
name|DBMSConnectionProperties
name|dbmsConnectionProperties
parameter_list|)
throws|throws
name|SQLException
throws|,
name|DatabaseNotSupportedException
throws|,
name|InvalidDBMSConnectionPropertiesException
block|{
name|BibDatabaseMode
name|selectedMode
init|=
name|Globals
operator|.
name|prefs
operator|.
name|getDefaultBibDatabaseMode
argument_list|()
decl_stmt|;
name|BibDatabaseContext
name|bibDatabaseContext
init|=
operator|new
name|BibDatabaseContext
argument_list|(
operator|new
name|Defaults
argument_list|(
name|selectedMode
argument_list|)
argument_list|)
decl_stmt|;
name|DBMSSynchronizer
name|synchronizer
init|=
operator|new
name|DBMSSynchronizer
argument_list|(
name|bibDatabaseContext
argument_list|,
name|Globals
operator|.
name|prefs
operator|.
name|getKeywordDelimiter
argument_list|()
argument_list|,
name|Globals
operator|.
name|prefs
operator|.
name|getKeyPattern
argument_list|()
argument_list|,
name|Globals
operator|.
name|getFileUpdateMonitor
argument_list|()
argument_list|)
decl_stmt|;
name|bibDatabaseContext
operator|.
name|convertToSharedDatabase
argument_list|(
name|synchronizer
argument_list|)
expr_stmt|;
name|dbmsSynchronizer
operator|=
name|bibDatabaseContext
operator|.
name|getDBMSSynchronizer
argument_list|()
expr_stmt|;
name|dbmsSynchronizer
operator|.
name|openSharedDatabase
argument_list|(
operator|new
name|DBMSConnection
argument_list|(
name|dbmsConnectionProperties
argument_list|)
argument_list|)
expr_stmt|;
name|dbmsSynchronizer
operator|.
name|registerListener
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|jabRefFrame
operator|.
name|getDialogService
argument_list|()
operator|.
name|notify
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Connection to %0 server established."
argument_list|,
name|dbmsConnectionProperties
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|jabRefFrame
operator|.
name|addTab
argument_list|(
name|bibDatabaseContext
argument_list|,
literal|true
argument_list|)
return|;
block|}
DECL|method|openSharedDatabaseFromParserResult (ParserResult parserResult)
specifier|public
name|void
name|openSharedDatabaseFromParserResult
parameter_list|(
name|ParserResult
name|parserResult
parameter_list|)
throws|throws
name|SQLException
throws|,
name|DatabaseNotSupportedException
throws|,
name|InvalidDBMSConnectionPropertiesException
throws|,
name|NotASharedDatabaseException
block|{
name|Optional
argument_list|<
name|String
argument_list|>
name|sharedDatabaseIDOptional
init|=
name|parserResult
operator|.
name|getDatabase
argument_list|()
operator|.
name|getSharedDatabaseID
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|sharedDatabaseIDOptional
operator|.
name|isPresent
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|NotASharedDatabaseException
argument_list|()
throw|;
block|}
name|String
name|sharedDatabaseID
init|=
name|sharedDatabaseIDOptional
operator|.
name|get
argument_list|()
decl_stmt|;
name|DBMSConnectionProperties
name|dbmsConnectionProperties
init|=
operator|new
name|DBMSConnectionProperties
argument_list|(
operator|new
name|SharedDatabasePreferences
argument_list|(
name|sharedDatabaseID
argument_list|)
argument_list|)
decl_stmt|;
name|BibDatabaseMode
name|selectedMode
init|=
name|Globals
operator|.
name|prefs
operator|.
name|getDefaultBibDatabaseMode
argument_list|()
decl_stmt|;
name|BibDatabaseContext
name|bibDatabaseContext
init|=
operator|new
name|BibDatabaseContext
argument_list|(
operator|new
name|Defaults
argument_list|(
name|selectedMode
argument_list|)
argument_list|)
decl_stmt|;
name|DBMSSynchronizer
name|synchronizer
init|=
operator|new
name|DBMSSynchronizer
argument_list|(
name|bibDatabaseContext
argument_list|,
name|Globals
operator|.
name|prefs
operator|.
name|getKeywordDelimiter
argument_list|()
argument_list|,
name|Globals
operator|.
name|prefs
operator|.
name|getKeyPattern
argument_list|()
argument_list|,
name|Globals
operator|.
name|getFileUpdateMonitor
argument_list|()
argument_list|)
decl_stmt|;
name|bibDatabaseContext
operator|.
name|convertToSharedDatabase
argument_list|(
name|synchronizer
argument_list|)
expr_stmt|;
name|bibDatabaseContext
operator|.
name|getDatabase
argument_list|()
operator|.
name|setSharedDatabaseID
argument_list|(
name|sharedDatabaseID
argument_list|)
expr_stmt|;
name|bibDatabaseContext
operator|.
name|setDatabaseFile
argument_list|(
name|parserResult
operator|.
name|getDatabaseContext
argument_list|()
operator|.
name|getDatabasePath
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
argument_list|)
expr_stmt|;
name|dbmsSynchronizer
operator|=
name|bibDatabaseContext
operator|.
name|getDBMSSynchronizer
argument_list|()
expr_stmt|;
name|dbmsSynchronizer
operator|.
name|openSharedDatabase
argument_list|(
operator|new
name|DBMSConnection
argument_list|(
name|dbmsConnectionProperties
argument_list|)
argument_list|)
expr_stmt|;
name|dbmsSynchronizer
operator|.
name|registerListener
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|parserResult
operator|.
name|setDatabaseContext
argument_list|(
name|bibDatabaseContext
argument_list|)
expr_stmt|;
name|jabRefFrame
operator|.
name|getDialogService
argument_list|()
operator|.
name|notify
argument_list|(
name|Localization
operator|.
name|lang
argument_list|(
literal|"Connection to %0 server established."
argument_list|,
name|dbmsConnectionProperties
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

