begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
DECL|package|org.jabref.gui.util
package|package
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|util
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|MalformedURLException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Paths
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Objects
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|javafx
operator|.
name|scene
operator|.
name|Scene
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|gui
operator|.
name|JabRefFrame
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|strings
operator|.
name|StringUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|model
operator|.
name|util
operator|.
name|FileUpdateMonitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jabref
operator|.
name|preferences
operator|.
name|JabRefPreferences
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * Installs the style file and provides live reloading.  *<p>  * The live reloading has to be turned on by setting the<code>-Djabref.theme.css</code> property.  * There two possible modes:  * (1) When only<code>-Djabref.theme.css</code> is specified, then the standard<code>Base.css</code> that is found will be watched  * and on changes in that file, the style-sheet will be reloaded and changes are immediately visible.  * (2) When a path to a css file is passed to<code>-Djabref.theme.css</code>, then the given style is loaded in addition to the base css file.  * Changes in the specified css file lead to an immediate redraw of the interface.  *<p>  * When working from an IDE, this usually means that the<code>Base.css</code> is located in the build folder.  * To use the css-file that is located in the sources directly, the full path can be given as value for the "VM option":  *<code>-Djabref.theme.css="/path/to/src/Base.css"</code>  */
end_comment

begin_class
DECL|class|ThemeLoader
specifier|public
class|class
name|ThemeLoader
block|{
DECL|field|MAIN_CSS
specifier|public
specifier|static
specifier|final
name|String
name|MAIN_CSS
init|=
literal|"Base.css"
decl_stmt|;
DECL|field|DARK_CSS
specifier|public
specifier|static
specifier|final
name|String
name|DARK_CSS
init|=
literal|"Dark.css"
decl_stmt|;
DECL|field|LOGGER
specifier|private
specifier|static
specifier|final
name|Logger
name|LOGGER
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|ThemeLoader
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|additionalCssToLoad
specifier|private
specifier|final
name|Optional
argument_list|<
name|URL
argument_list|>
name|additionalCssToLoad
decl_stmt|;
DECL|field|fileUpdateMonitor
specifier|private
specifier|final
name|FileUpdateMonitor
name|fileUpdateMonitor
decl_stmt|;
DECL|method|ThemeLoader (FileUpdateMonitor fileUpdateMonitor, JabRefPreferences jabRefPreferences)
specifier|public
name|ThemeLoader
parameter_list|(
name|FileUpdateMonitor
name|fileUpdateMonitor
parameter_list|,
name|JabRefPreferences
name|jabRefPreferences
parameter_list|)
block|{
name|this
operator|.
name|fileUpdateMonitor
operator|=
name|Objects
operator|.
name|requireNonNull
argument_list|(
name|fileUpdateMonitor
argument_list|)
expr_stmt|;
name|String
name|cssVmArgument
init|=
name|System
operator|.
name|getProperty
argument_list|(
literal|"jabref.theme.css"
argument_list|)
decl_stmt|;
name|String
name|cssPreferences
init|=
name|jabRefPreferences
operator|.
name|get
argument_list|(
name|JabRefPreferences
operator|.
name|FX_THEME
argument_list|)
decl_stmt|;
if|if
condition|(
name|StringUtil
operator|.
name|isNotBlank
argument_list|(
name|cssVmArgument
argument_list|)
condition|)
block|{
comment|// First priority: VM argument
name|LOGGER
operator|.
name|info
argument_list|(
literal|"Using css from VM option: "
operator|+
name|cssVmArgument
argument_list|)
expr_stmt|;
name|URL
name|cssVmUrl
init|=
literal|null
decl_stmt|;
try|try
block|{
name|cssVmUrl
operator|=
name|Paths
operator|.
name|get
argument_list|(
name|cssVmArgument
argument_list|)
operator|.
name|toUri
argument_list|()
operator|.
name|toURL
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|MalformedURLException
name|e
parameter_list|)
block|{
name|LOGGER
operator|.
name|warn
argument_list|(
literal|"Cannot load css "
operator|+
name|cssVmArgument
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
name|additionalCssToLoad
operator|=
name|Optional
operator|.
name|ofNullable
argument_list|(
name|cssVmUrl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|StringUtil
operator|.
name|isNotBlank
argument_list|(
name|cssPreferences
argument_list|)
operator|&&
operator|!
name|MAIN_CSS
operator|.
name|equalsIgnoreCase
argument_list|(
name|cssPreferences
argument_list|)
condition|)
block|{
comment|// Otherwise load css from preference
name|URL
name|cssResource
init|=
name|JabRefFrame
operator|.
name|class
operator|.
name|getResource
argument_list|(
name|cssPreferences
argument_list|)
decl_stmt|;
if|if
condition|(
name|cssResource
operator|!=
literal|null
condition|)
block|{
name|LOGGER
operator|.
name|debug
argument_list|(
literal|"Using css "
operator|+
name|cssResource
argument_list|)
expr_stmt|;
name|additionalCssToLoad
operator|=
name|Optional
operator|.
name|of
argument_list|(
name|cssResource
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|additionalCssToLoad
operator|=
name|Optional
operator|.
name|empty
argument_list|()
expr_stmt|;
name|LOGGER
operator|.
name|warn
argument_list|(
literal|"Cannot load css "
operator|+
name|cssPreferences
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|additionalCssToLoad
operator|=
name|Optional
operator|.
name|empty
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Installs the base css file as a stylesheet in the given scene. Changes in the css file lead to a redraw of the      * scene using the new css file.      */
DECL|method|installCss (Scene scene, JabRefPreferences preferences)
specifier|public
name|void
name|installCss
parameter_list|(
name|Scene
name|scene
parameter_list|,
name|JabRefPreferences
name|preferences
parameter_list|)
block|{
name|addAndWatchForChanges
argument_list|(
name|scene
argument_list|,
name|JabRefFrame
operator|.
name|class
operator|.
name|getResource
argument_list|(
name|MAIN_CSS
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|additionalCssToLoad
operator|.
name|ifPresent
argument_list|(
name|file
lambda|->
name|addAndWatchForChanges
argument_list|(
name|scene
argument_list|,
name|file
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|preferences
operator|.
name|getFontSize
argument_list|()
operator|.
name|ifPresent
argument_list|(
name|size
lambda|->
name|scene
operator|.
name|getRoot
argument_list|()
operator|.
name|setStyle
argument_list|(
literal|"-fx-font-size: "
operator|+
name|size
operator|+
literal|"pt;"
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|addAndWatchForChanges (Scene scene, URL cssFile, int index)
specifier|private
name|void
name|addAndWatchForChanges
parameter_list|(
name|Scene
name|scene
parameter_list|,
name|URL
name|cssFile
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|scene
operator|.
name|getStylesheets
argument_list|()
operator|.
name|add
argument_list|(
name|index
argument_list|,
name|cssFile
operator|.
name|toExternalForm
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|URI
name|cssUri
init|=
name|cssFile
operator|.
name|toURI
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|cssUri
operator|.
name|toString
argument_list|()
operator|.
name|contains
argument_list|(
literal|"jar"
argument_list|)
condition|)
block|{
name|LOGGER
operator|.
name|debug
argument_list|(
literal|"CSS URI {}"
argument_list|,
name|cssUri
argument_list|)
expr_stmt|;
name|Path
name|cssPath
init|=
name|Paths
operator|.
name|get
argument_list|(
name|cssUri
argument_list|)
operator|.
name|toAbsolutePath
argument_list|()
decl_stmt|;
comment|// If the file is an ordinary file (i.e. not a resource part of a .jar bundle), we watch it for changes and turn on live reloading
if|if
condition|(
operator|!
name|cssUri
operator|.
name|toString
argument_list|()
operator|.
name|contains
argument_list|(
literal|"jar"
argument_list|)
condition|)
block|{
name|LOGGER
operator|.
name|info
argument_list|(
literal|"Enabling live reloading of {}"
argument_list|,
name|cssPath
argument_list|)
expr_stmt|;
name|fileUpdateMonitor
operator|.
name|addListenerForFile
argument_list|(
name|cssPath
argument_list|,
parameter_list|()
lambda|->
block|{
name|LOGGER
operator|.
name|info
argument_list|(
literal|"Reload css file "
operator|+
name|cssFile
argument_list|)
expr_stmt|;
name|DefaultTaskExecutor
operator|.
name|runInJavaFXThread
argument_list|(
parameter_list|()
lambda|->
block|{
name|scene
operator|.
name|getStylesheets
argument_list|()
operator|.
name|remove
argument_list|(
name|cssFile
operator|.
name|toExternalForm
argument_list|()
argument_list|)
expr_stmt|;
name|scene
operator|.
name|getStylesheets
argument_list|()
operator|.
name|add
argument_list|(
name|index
argument_list|,
name|cssFile
operator|.
name|toExternalForm
argument_list|()
argument_list|)
expr_stmt|;
block|}
argument_list|)
expr_stmt|;
block|}
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|IOException
decl||
name|URISyntaxException
decl||
name|UnsupportedOperationException
name|e
parameter_list|)
block|{
name|LOGGER
operator|.
name|error
argument_list|(
literal|"Could not watch css file for changes "
operator|+
name|cssFile
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

